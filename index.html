<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Operaci√≥n ‚Äì Estado de Recertificaciones (CLARO)</title>

<script src="https://unpkg.com/@supabase/supabase-js@2"></script>

<style>
:root{
  --violeta:#a78bfa; --violeta-osc:#7c3aed;
  --bg:#050617; --bg2:#111827; --card:#0f172a;
  --text:#e8e6ff; --muted:#bfbde6; --border:rgba(167,139,250,.22);
  --ok:#34d399; --warn:#facc15; --bad:#f87171; --info:#60a5fa;
}
*{box-sizing:border-box;font-family:system-ui,Segoe UI,Roboto,Arial;}
body{
  margin:0;min-height:100vh;
  background:radial-gradient(circle at top,var(--bg2),var(--bg));
  color:var(--text); padding:18px;
}
.hidden{display:none!important;}
.wrap{max-width:1200px;margin:0 auto;}
.card{
  background:rgba(15,23,42,.92);
  border:1px solid var(--border);
  border-radius:18px;
  box-shadow:0 18px 45px rgba(0,0,0,.55);
  padding:16px;
}
h1{margin:0 0 6px 0;font-size:26px;letter-spacing:.2px}
.sub{color:var(--muted);font-size:13px;margin-bottom:12px}
.row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
input,select{
  padding:10px 12px;border-radius:12px;
  background:#0b1020;color:var(--text);
  border:1px solid rgba(167,139,250,.35);
  outline:none;
}
button{
  border:0;border-radius:999px;padding:10px 14px;
  font-weight:700;cursor:pointer;color:white;
  background:linear-gradient(135deg,var(--violeta-osc),var(--violeta));
}
button.sec{
  background:#111827;border:1px solid rgba(167,139,250,.35);
}
button:disabled{opacity:.6;cursor:not-allowed}
.kpis{display:grid;grid-template-columns:repeat(4,minmax(180px,1fr));gap:10px;margin:12px 0 10px}
.kpi{
  border:1px solid rgba(167,139,250,.18);
  border-radius:16px;background:rgba(2,6,23,.45);
  padding:12px;
}
.kpi .t{font-size:12px;color:var(--muted);margin-bottom:6px}
.kpi .v{font-size:22px;font-weight:900}
.badge{display:inline-flex;align-items:center;gap:6px;padding:4px 10px;border-radius:999px;font-size:12px;font-weight:800;border:1px solid transparent}
.b-ok{background:rgba(52,211,153,.14);border-color:rgba(52,211,153,.35);color:var(--ok)}
.b-warn{background:rgba(250,204,21,.13);border-color:rgba(250,204,21,.35);color:var(--warn)}
.b-bad{background:rgba(248,113,113,.13);border-color:rgba(248,113,113,.35);color:var(--bad)}
.b-info{background:rgba(96,165,250,.13);border-color:rgba(96,165,250,.35);color:var(--info)}

.table-wrap{
  margin-top:10px;max-height:520px;overflow:auto;border-radius:14px;
  border:1px solid rgba(167,139,250,.18);background:#050617;
}
table{width:100%;border-collapse:collapse;font-size:12px}
thead{position:sticky;top:0;background:#0b1020}
th,td{padding:10px 10px;border-bottom:1px solid rgba(167,139,250,.10);text-align:left}
tbody tr:nth-child(even){background:rgba(15,23,42,.35)}
tbody tr:hover{background:rgba(167,139,250,.08)}
small{color:var(--muted)}
hr{border:none;border-top:1px solid rgba(167,139,250,.18);margin:14px 0}
</style>
</head>

<body>
<div class="wrap">

  <!-- ============ LOGIN ============ -->
  <div class="card" id="loginCard">
    <h1>Operaci√≥n ‚Äì Dashboard Recertificaciones (CLARO)</h1>
    <div class="sub">Inicia sesi√≥n para ver el estado de certificaciones de <b>todos</b> los empleados.</div>

    <div class="row">
      <div style="flex:1;min-width:240px">
        <div style="font-size:12px;color:var(--muted);margin-bottom:6px">Correo</div>
        <input id="email" type="email" placeholder="correo@dico.com.co" style="width:100%">
      </div>
      <div style="flex:1;min-width:220px">
        <div style="font-size:12px;color:var(--muted);margin-bottom:6px">Contrase√±a</div>
        <input id="pass" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" style="width:100%">
      </div>
      <div style="min-width:160px">
        <div style="height:18px"></div>
        <button id="loginBtn" style="width:100%">Ingresar</button>
      </div>
    </div>

    <div id="loginStatus" class="sub" style="margin-top:10px"></div>

    <hr>
    <div class="sub" style="margin:0">
      Si te sale error de credenciales: primero crea el usuario en <b>Authentication ‚Üí Users</b> (o reg√≠stralo desde tu m√≥dulo principal).
    </div>
  </div>

  <!-- ============ DASHBOARD ============ -->
  <div class="card hidden" id="dashCard">
    <div class="row" style="justify-content:space-between">
      <div>
        <h1 style="margin-bottom:2px">Dashboard Certificaciones</h1>
        <div class="sub" style="margin:0">Vigentes ¬∑ Por vencer (‚â§ 30 d√≠as) ¬∑ Vencidos</div>
      </div>
      <div class="row">
        <div class="sub" id="userBadge" style="margin:0"></div>
        <button class="sec" id="logoutBtn">Salir</button>
      </div>
    </div>

    <!-- KPIs -->
    <div class="kpis">
      <div class="kpi">
        <div class="t">‚úÖ Vigentes</div>
        <div class="v" id="kVig">‚Äî</div>
      </div>
      <div class="kpi">
        <div class="t">‚ö†Ô∏è Por vencer (‚â§ 30 d√≠as)</div>
        <div class="v" id="kPorV">‚Äî</div>
      </div>
      <div class="kpi">
        <div class="t">‚ùå Vencidos</div>
        <div class="v" id="kVenc">‚Äî</div>
      </div>
      <div class="kpi">
        <div class="t">üì¶ Total registros</div>
        <div class="v" id="kTot">‚Äî</div>
      </div>
    </div>

    <!-- Filtros -->
    <div class="row" style="margin-top:6px">
      <div>
        <div style="font-size:12px;color:var(--muted);margin-bottom:6px">Filtro estado</div>
        <select id="estadoSel">
          <option value="TODOS">Todos</option>
          <option value="VIGENTE">Vigente</option>
          <option value="POR_VENCER">Por vencer</option>
          <option value="VENCIDO">Vencido</option>
          <option value="SIN_FECHA">Sin fecha</option>
        </select>
      </div>

      <div style="flex:1;min-width:260px">
        <div style="font-size:12px;color:var(--muted);margin-bottom:6px">Buscar (documento / nombre / cargo / certificaci√≥n)</div>
        <input id="q" placeholder="Ej: 1030 / Nicolas / T√©cnico / Certificaci√≥n ‚Äì ..." style="width:100%">
      </div>

      <div>
        <div style="font-size:12px;color:var(--muted);margin-bottom:6px">Solo pr√≥ximos a vencer</div>
        <select id="proxSel">
          <option value="0">Sin filtro</option>
          <option value="30">‚â§ 30 d√≠as</option>
          <option value="15">‚â§ 15 d√≠as</option>
          <option value="7">‚â§ 7 d√≠as</option>
        </select>
      </div>

      <div class="row">
        <button id="refBtn">Actualizar</button>
        <button class="sec" id="csvBtn">Exportar CSV</button>
      </div>
    </div>

    <div class="sub" id="status" style="margin:10px 0 0 0">Listo.</div>

    <!-- Tabla -->
    <div class="table-wrap">
      <table>
        <thead>
          <tr>
            <th>Documento</th>
            <th>Nombre</th>
            <th>Cargo</th>
            <th>Certificaci√≥n</th>
            <th>Desde</th>
            <th>Vence</th>
            <th>D√≠as</th>
            <th>Estado</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>

  </div>

</div>

<script>
/* ================= SUPABASE CONFIG (TU PROYECTO NUEVO) ================= */
const SUPABASE_URL = "https://zltjlwfnqrjojguewaiq.supabase.co";
const SUPABASE_KEY = "sb_publishable_Q_-wmXnWL1V5A8gjSgjZTQ_UumLas2f";
const sb = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

/* ================= DOM ================= */
const loginCard = document.getElementById("loginCard");
const dashCard  = document.getElementById("dashCard");
const loginStatus = document.getElementById("loginStatus");
const userBadge = document.getElementById("userBadge");

const email = document.getElementById("email");
const pass  = document.getElementById("pass");
const loginBtn = document.getElementById("loginBtn");
const logoutBtn = document.getElementById("logoutBtn");

const kVig = document.getElementById("kVig");
const kPorV = document.getElementById("kPorV");
const kVenc = document.getElementById("kVenc");
const kTot = document.getElementById("kTot");

const estadoSel = document.getElementById("estadoSel");
const proxSel = document.getElementById("proxSel");
const q = document.getElementById("q");
const refBtn = document.getElementById("refBtn");
const csvBtn = document.getElementById("csvBtn");
const status = document.getElementById("status");
const tbody = document.getElementById("tbody");

let RAW = []; // datos crudos para filtrar y exportar

/* ================= HELPERS ================= */
function iso(d){ return (d||"").slice(0,10); }

function daysBetweenToday(dateISO){
  if(!dateISO) return null;
  const t0 = new Date();
  const today = new Date(t0.getFullYear(), t0.getMonth(), t0.getDate()); // sin hora
  const x = new Date(dateISO + "T00:00:00");
  const ms = x - today;
  return Math.floor(ms / (1000*60*60*24));
}

function calcEstado(vigencia_hasta){
  const d = daysBetweenToday(vigencia_hasta);
  if(d === null) return { key:"SIN_FECHA", label:"Sin fecha", cls:"b-info", dias:"‚Äî" };
  if(d < 0) return { key:"VENCIDO", label:"Vencido", cls:"b-bad", dias:String(d) };
  if(d <= 30) return { key:"POR_VENCER", label:"Por vencer", cls:"b-warn", dias:String(d) };
  return { key:"VIGENTE", label:"Vigente", cls:"b-ok", dias:String(d) };
}

function esc(s){
  return String(s ?? "").replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;");
}

/* ================= AUTH ================= */
loginBtn.onclick = async () => {
  const e = email.value.trim();
  const p = pass.value.trim();
  if(!e || !p){ loginStatus.textContent = "‚ùå Digita correo y contrase√±a."; return; }

  loginStatus.textContent = "Ingresando...";
  const { data, error } = await sb.auth.signInWithPassword({ email:e, password:p });

  if(error){ loginStatus.textContent = "‚ùå " + error.message; return; }

  loginStatus.textContent = "‚úÖ OK";
  loginCard.classList.add("hidden");
  dashCard.classList.remove("hidden");
  userBadge.textContent = data.user.email;

  await cargarTodo();
};

logoutBtn.onclick = async () => {
  await sb.auth.signOut();
};

sb.auth.onAuthStateChange(async (event, session) => {
  if(session?.user){
    loginCard.classList.add("hidden");
    dashCard.classList.remove("hidden");
    userBadge.textContent = session.user.email;
    await cargarTodo();
  }else{
    dashCard.classList.add("hidden");
    loginCard.classList.remove("hidden");
  }
});

/* ================= DATA LOAD ================= */
/**
 * Lee TODAS las certificaciones (employee_certifications)
 * y trae datos del empleado desde employees (relaci√≥n por employee_id).
 */
async function cargarTodo(){
  status.textContent = "Cargando certificaciones...";
  tbody.innerHTML = "";
  RAW = [];

  // Trae todo (si tienes muchos registros, luego hacemos paginaci√≥n)
  const { data, error } = await sb
    .from("employee_certifications")
    .select(`
      employee_id,
      certificacion,
      vigencia_desde,
      vigencia_hasta,
      updated_at,
      employees (
        documento,
        nombre,
        cargo
      )
    `)
    .order("vigencia_hasta", { ascending: true });

  if(error){
    status.textContent = "‚ùå Error: " + error.message;
    return;
  }

  RAW = (data || []).map(r => {
    const emp = r.employees || {};
    const est = calcEstado(r.vigencia_hasta);
    return {
      documento: emp.documento || "",
      nombre: emp.nombre || "",
      cargo: emp.cargo || "",
      certificacion: r.certificacion || "",
      vigencia_desde: iso(r.vigencia_desde),
      vigencia_hasta: iso(r.vigencia_hasta),
      dias: est.dias,
      estado_key: est.key,
      estado_label: est.label,
      estado_cls: est.cls
    };
  });

  aplicarFiltros();
  status.textContent = "Listo.";
}

/* ================= FILTER + RENDER ================= */
function aplicarFiltros(){
  const est = estadoSel.value;
  const prox = Number(proxSel.value || "0");
  const qq = q.value.trim().toLowerCase();

  let rows = RAW.slice();

  if(est !== "TODOS"){
    rows = rows.filter(r => r.estado_key === est);
  }

  if(prox > 0){
    rows = rows.filter(r => {
      const d = (r.dias === "‚Äî") ? null : Number(r.dias);
      return (d !== null && d >= 0 && d <= prox);
    });
  }

  if(qq){
    rows = rows.filter(r => {
      const blob = (r.documento+" "+r.nombre+" "+r.cargo+" "+r.certificacion).toLowerCase();
      return blob.includes(qq);
    });
  }

  // KPIs sobre TODO RAW (sin filtros de b√∫squeda), como operaci√≥n suele requerir global:
  const tot = RAW.length;
  const vig = RAW.filter(r=>r.estado_key==="VIGENTE").length;
  const porv = RAW.filter(r=>r.estado_key==="POR_VENCER").length;
  const venc = RAW.filter(r=>r.estado_key==="VENCIDO").length;

  kTot.textContent = tot;
  kVig.textContent = vig;
  kPorV.textContent = porv;
  kVenc.textContent = venc;

  // render
  tbody.innerHTML = rows.length ? "" : `
    <tr><td colspan="8" style="text-align:center;color:var(--muted);padding:18px">
      Sin resultados con los filtros actuales.
    </td></tr>
  `;

  for(const r of rows){
    tbody.innerHTML += `
      <tr>
        <td>${esc(r.documento)}</td>
        <td>${esc(r.nombre)}</td>
        <td>${esc(r.cargo)}</td>
        <td>${esc(r.certificacion)}</td>
        <td><small>${esc(r.vigencia_desde || "‚Äî")}</small></td>
        <td><small>${esc(r.vigencia_hasta || "‚Äî")}</small></td>
        <td><b>${esc(r.dias)}</b></td>
        <td><span class="badge ${r.estado_cls}">${esc(r.estado_label)}</span></td>
      </tr>
    `;
  }

  status.textContent = `Mostrando: ${rows.length} / ${RAW.length}`;
}

estadoSel.onchange = aplicarFiltros;
proxSel.onchange = aplicarFiltros;
q.oninput = () => { aplicarFiltros(); };

refBtn.onclick = cargarTodo;

/* ================= CSV EXPORT ================= */
csvBtn.onclick = () => {
  // exporta LO QUE EST√Å FILTRADO en pantalla
  const est = estadoSel.value;
  const prox = Number(proxSel.value || "0");
  const qq = q.value.trim().toLowerCase();

  let rows = RAW.slice();
  if(est !== "TODOS") rows = rows.filter(r => r.estado_key === est);
  if(prox > 0){
    rows = rows.filter(r => {
      const d = (r.dias === "‚Äî") ? null : Number(r.dias);
      return (d !== null && d >= 0 && d <= prox);
    });
  }
  if(qq){
    rows = rows.filter(r => (r.documento+" "+r.nombre+" "+r.cargo+" "+r.certificacion).toLowerCase().includes(qq));
  }

  const header = ["documento","nombre","cargo","certificacion","vigencia_desde","vigencia_hasta","dias","estado"];
  const lines = [header.join(",")];

  for(const r of rows){
    const line = [
      r.documento, r.nombre, r.cargo, r.certificacion,
      r.vigencia_desde, r.vigencia_hasta, r.dias, r.estado_label
    ].map(x => `"${String(x ?? "").replaceAll('"','""')}"`).join(",");
    lines.push(line);
  }

  const blob = new Blob([lines.join("\n")], { type:"text/csv;charset=utf-8" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "recertificaciones_claro.csv";
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);
};
</script>

</body>
</html>
