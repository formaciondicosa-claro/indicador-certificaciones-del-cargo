<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Operaci√≥n ‚Äì Estado de Recertificaciones (CLARO)</title>

<script src="https://unpkg.com/@supabase/supabase-js@2"></script>

<style>
:root{
  --violeta:#a78bfa; --violeta-osc:#7c3aed;
  --bg:#050617; --bg2:#111827; --card:#0f172a;
  --text:#e8e6ff; --muted:#bfbde6; --border:rgba(167,139,250,.22);
  --ok:#34d399; --warn:#facc15; --bad:#f87171; --info:#60a5fa;
}
*{box-sizing:border-box;font-family:system-ui,Segoe UI,Roboto,Arial;}
body{
  margin:0;min-height:100vh;
  background:radial-gradient(circle at top,var(--bg2),var(--bg));
  color:var(--text); padding:18px;
}
.hidden{display:none!important;}
.wrap{max-width:1200px;margin:0 auto;}
.card{
  background:rgba(15,23,42,.92);
  border:1px solid var(--border);
  border-radius:18px;
  box-shadow:0 18px 45px rgba(0,0,0,.55);
  padding:16px;
}
h1{margin:0 0 6px 0;font-size:26px;letter-spacing:.2px}
.sub{color:var(--muted);font-size:13px;margin-bottom:12px}
.row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
input,select{
  padding:10px 12px;border-radius:12px;
  background:#0b1020;color:var(--text);
  border:1px solid rgba(167,139,250,.35);
  outline:none;
}
button{
  border:0;border-radius:999px;padding:10px 14px;
  font-weight:700;cursor:pointer;color:white;
  background:linear-gradient(135deg,var(--violeta-osc),var(--violeta));
}
button.sec{
  background:#111827;border:1px solid rgba(167,139,250,.35);
}
button:disabled{opacity:.6;cursor:not-allowed}
.kpis{display:grid;grid-template-columns:repeat(4,minmax(180px,1fr));gap:10px;margin:12px 0 10px}
.kpi{
  border:1px solid rgba(167,139,250,.18);
  border-radius:16px;background:rgba(2,6,23,.45);
  padding:12px;
}
.kpi .t{font-size:12px;color:var(--muted);margin-bottom:6px}
.kpi .v{font-size:22px;font-weight:900}
.badge{display:inline-flex;align-items:center;gap:6px;padding:4px 10px;border-radius:999px;font-size:12px;font-weight:800;border:1px solid transparent}
.b-ok{background:rgba(52,211,153,.14);border-color:rgba(52,211,153,.35);color:var(--ok)}
.b-warn{background:rgba(250,204,21,.13);border-color:rgba(250,204,21,.35);color:var(--warn)}
.b-bad{background:rgba(248,113,113,.13);border-color:rgba(248,113,113,.35);color:var(--bad)}
.b-info{background:rgba(96,165,250,.13);border-color:rgba(96,165,250,.35);color:var(--info)}

.table-wrap{
  margin-top:10px;max-height:520px;overflow:auto;border-radius:14px;
  border:1px solid rgba(167,139,250,.18);background:#050617;
}
table{width:100%;border-collapse:collapse;font-size:12px}
thead{position:sticky;top:0;background:#0b1020}
th,td{padding:10px 10px;border-bottom:1px solid rgba(167,139,250,.10);text-align:left}
tbody tr:nth-child(even){background:rgba(15,23,42,.35)}
tbody tr:hover{background:rgba(167,139,250,.08)}
small{color:var(--muted)}
hr{border:none;border-top:1px solid rgba(167,139,250,.18);margin:14px 0}
</style>
</head>

<body>
<div class="wrap">

  <!-- ============ LOGIN ============ -->
  <div class="card" id="loginCard">
    <h1>Operaci√≥n ‚Äì Dashboard Recertificaciones (CLARO)</h1>
    <div class="sub">Inicia sesi√≥n para ver el estado de certificaciones de <b>todos</b> los empleados.</div>

    <div class="row">
      <div style="flex:1;min-width:240px">
        <div style="font-size:12px;color:var(--muted);margin-bottom:6px">Correo</div>
        <input id="email" type="email" placeholder="correo@dico.com.co" style="width:100%">
      </div>
      <div style="flex:1;min-width:220px">
        <div style="font-size:12px;color:var(--muted);margin-bottom:6px">Contrase√±a</div>
        <input id="pass" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" style="width:100%">
      </div>
      <div style="min-width:160px">
        <div style="height:18px"></div>
        <button id="loginBtn" style="width:100%">Ingresar</button>
      </div>
    </div>

    <div id="loginStatus" class="sub" style="margin-top:10px"></div>

    <hr>
    <div class="sub" style="margin:0">
      Si te sale error de credenciales: primero crea el usuario en <b>Authentication ‚Üí Users</b> (o reg√≠stralo desde tu m√≥dulo principal).
    </div>
  </div>

  <!-- ============ DASHBOARD ============ -->
  <div class="card hidden" id="dashCard">
    <div class="row" style="justify-content:space-between">
      <div>
        <h1 style="margin-bottom:2px">Dashboard Certificaciones</h1>
        <div class="sub" style="margin:0">Vigentes ¬∑ Por vencer (‚â§ 30 d√≠as) ¬∑ Vencidos</div>
      </div>
      <div class="row">
        <div class="sub" id="userBadge" style="margin:0"></div>
        <button class="sec" id="logoutBtn">Salir</button>
      </div>
    </div>

    <!-- KPIs -->
    <div class="kpis">
      <div class="kpi">
        <div class="t">‚úÖ Vigentes</div>
        <div class="v" id="kVig">‚Äî</div>
      </div>
      <div class="kpi">
        <div class="t">‚ö†Ô∏è Por vencer (‚â§ 30 d√≠as)</div>
        <div class="v" id="kPorV">‚Äî</div>
      </div>
      <div class="kpi">
        <div class="t">‚ùå Vencidos</div>
        <div class="v" id="kVenc">‚Äî</div>
      </div>
      <div class="kpi">
        <div class="t">üì¶ Total registros</div>
        <div class="v" id="kTot">‚Äî</div>
      </div>
    </div>
<!-- RESUMEN POR √ÅREA (CONTEOS + %) -->
<div style="margin-top:10px">
  <div class="sub" style="margin:0 0 8px 0">
    Resumen por √Årea (conteos y porcentajes)
  </div>

  <div class="table-wrap" style="max-height:260px">
    <table>
      <thead>
        <tr>
          <th>√Årea</th>
          <th>Total</th>
          <th>Vigentes</th>
          <th>Por vencer</th>
          <th>Vencidos</th>
          <th>Pendientes</th>
          <th>% del total</th>
        </tr>
      </thead>
      <tbody id="areaTbody"></tbody>
    </table>
  </div>
</div>
    <!-- Filtros -->
    <div class="row" style="margin-top:6px">
      <div>
        <div style="font-size:12px;color:var(--muted);margin-bottom:6px">Filtro estado</div>
        <select id="estadoSel">
          <option value="TODOS">Todos</option>
          <option value="VIGENTE">Vigente</option>
          <option value="POR_VENCER">Por vencer</option>
          <option value="VENCIDO">Vencido</option>
          <option value="SIN_FECHA">Sin fecha</option>
          <option value="PENDIENTE">Pendiente</option>
<option value="NO_ENCONTRADO">No encontrado</option>
        </select>
      </div>
<div>
  <div style="font-size:12px;color:var(--muted);margin-bottom:6px">√Årea</div>
  <select id="areaSel">
    <option value="TODAS">Todas</option>
  </select>
</div>
      <div style="flex:1;min-width:260px">
        <div style="font-size:12px;color:var(--muted);margin-bottom:6px">Buscar (documento / nombre / cargo / certificaci√≥n)</div>
        <input id="q" placeholder="Ej: 1030 / Nicolas / T√©cnico / Certificaci√≥n ‚Äì ..." style="width:100%">
      </div>

      <div>
        <div style="font-size:12px;color:var(--muted);margin-bottom:6px">Solo pr√≥ximos a vencer</div>
        <select id="proxSel">
          <option value="0">Sin filtro</option>
          <option value="30">‚â§ 30 d√≠as</option>
          <option value="15">‚â§ 15 d√≠as</option>
          <option value="7">‚â§ 7 d√≠as</option>
        </select>
      </div>

      <div class="row">
        <button id="refBtn">Actualizar</button>
        <button class="sec" id="csvBtn">Exportar CSV</button>
      </div>
    </div>

    <div class="sub" id="status" style="margin:10px 0 0 0">Listo.</div>

    <!-- Tabla -->
    <div class="table-wrap">
      <table>
        <thead>
          <tr>
            <th>Documento</th>
            <th>Nombre</th>
            <th>Cargo</th>
            <th>√Årea</th>
            <th>Certificaci√≥n</th>
            <th>Desde</th>
            <th>Vence</th>
            <th>D√≠as</th>
            <th>Estado</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>

  </div>

</div>

<script>
/* ================= SUPABASE CONFIG (TU PROYECTO NUEVO) ================= */
const SUPABASE_URL = "https://zltjlwfnqrjojguewaiq.supabase.co";
const SUPABASE_KEY = "sb_publishable_Q_-wmXnWL1V5A8gjSgjZTQ_UumLas2f";
const sb = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

/* ================= DOM ================= */
const loginCard = document.getElementById("loginCard");
const dashCard  = document.getElementById("dashCard");
const loginStatus = document.getElementById("loginStatus");
const userBadge = document.getElementById("userBadge");

const email = document.getElementById("email");
const pass  = document.getElementById("pass");
const loginBtn = document.getElementById("loginBtn");
const logoutBtn = document.getElementById("logoutBtn");

const kVig = document.getElementById("kVig");
const kPorV = document.getElementById("kPorV");
const kVenc = document.getElementById("kVenc");
const kTot = document.getElementById("kTot");

const estadoSel = document.getElementById("estadoSel");
  const areaSel = document.getElementById("areaSel");
const proxSel = document.getElementById("proxSel");
const q = document.getElementById("q");
const refBtn = document.getElementById("refBtn");
const csvBtn = document.getElementById("csvBtn");
const status = document.getElementById("status");
const tbody = document.getElementById("tbody");
const areaTbody = document.getElementById("areaTbody");
let RAW = []; // datos crudos para filtrar y exportar

/* ================= HELPERS ================= */
function iso(d){ return (d||"").slice(0,10); }

function daysBetweenToday(dateISO){
  if(!dateISO) return null;
  const t0 = new Date();
  const today = new Date(t0.getFullYear(), t0.getMonth(), t0.getDate()); // sin hora
  const x = new Date(dateISO + "T00:00:00");
  const ms = x - today;
  return Math.floor(ms / (1000*60*60*24));
}

function calcEstado(vigencia_hasta){
  const d = daysBetweenToday(vigencia_hasta);
  if(d === null) return { key:"SIN_FECHA", label:"Sin fecha", cls:"b-info", dias:"‚Äî" };
  if(d < 0) return { key:"VENCIDO", label:"Vencido", cls:"b-bad", dias:String(d) };
  if(d <= 30) return { key:"POR_VENCER", label:"Por vencer", cls:"b-warn", dias:String(d) };
  return { key:"VIGENTE", label:"Vigente", cls:"b-ok", dias:String(d) };
}

function esc(s){
  return String(s ?? "").replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;");
}

/* ================= AUTH ================= */
loginBtn.onclick = async () => {
  const e = email.value.trim();
  const p = pass.value.trim();
  if(!e || !p){ loginStatus.textContent = "‚ùå Digita correo y contrase√±a."; return; }

  loginStatus.textContent = "Ingresando...";
  const { data, error } = await sb.auth.signInWithPassword({ email:e, password:p });

  if(error){ loginStatus.textContent = "‚ùå " + error.message; return; }

  loginStatus.textContent = "‚úÖ OK";
  loginCard.classList.add("hidden");
  dashCard.classList.remove("hidden");
  userBadge.textContent = data.user.email;

  // ‚úÖ CARGA SIEMPRE AQU√ç (para que no quede en 0/0)
  await cargarTodo();
};
logoutBtn.onclick = async () => {
  await sb.auth.signOut();
  location.reload(); // vuelve al login
};
sb.auth.onAuthStateChange(async (event, session) => {
  console.log("AUTH EVENT:", event, "session?", !!session);

  if(session?.user){
    loginCard.classList.add("hidden");
    dashCard.classList.remove("hidden");
    userBadge.textContent = session.user.email;

    // ‚úÖ SOLO cuando la p√°gina carga y ya hab√≠a sesi√≥n guardada
    if(event === "INITIAL_SESSION"){
      await cargarTodo();
    }

  }else{
    dashCard.classList.add("hidden");
    loginCard.classList.remove("hidden");
  }
});
/* ================= DATA LOAD ================= */
/**
 * Lee TODAS las certificaciones (employee_certifications)
 * y trae datos del empleado desde employees (relaci√≥n por employee_id).
 */
async function cargarTodo(){
  status.textContent = "Cargando certificaciones (CLARO)...";
  tbody.innerHTML = "";
  RAW = [];

  // 1) KPIs reales (desde la vista v_kpi_client_cert)
  const { data: kpiData, error: kpiErr } = await sb
    .from("v_kpi_client_cert")
    .select("total_registros, vigentes, por_vencer_30, vencidas")
    .eq("cliente", "CLARO")
    .single();

  if(kpiErr){
    console.error("KPI ERROR:", kpiErr);
    // No detenemos el dashboard por KPIs; solo avisamos
  } else {
    kTot.textContent = kpiData.total_registros ?? "‚Äî";
    kVig.textContent = kpiData.vigentes ?? "‚Äî";
    kPorV.textContent = kpiData.por_vencer_30 ?? "‚Äî";
    kVenc.textContent = kpiData.vencidas ?? "‚Äî";
  }

  // 2) Tabla (desde la vista FIX que ya trae area)
  //    Si NO creaste la vista FIX, cambia el nombre por "v_employee_client_cert_status"
const { data, error } = await sb
  .rpc("rpc_employee_client_cert_status", { p_cliente: "CLARO" });

if(error){
  console.error("DATA ERROR:", error);
  status.textContent = "‚ùå Error cargando datos: " + (error.message || "Sin mensaje");
  alert(
    "Error cargando datos:\n" +
    "message: " + (error.message || "") + "\n" +
    "details: " + (error.details || "") + "\n" +
    "hint: " + (error.hint || "") + "\n" +
    "code: " + (error.code || "")
  );
  return;
}

console.log("RPC data length:", (data || []).length);
status.textContent = "RPC OK. Registros: " + ((data || []).length);
  // 3) Construir RAW para filtros/render
RAW = (data || []).map(r => {
  const key = String(r.estado_calc || "").toUpperCase();

  // ‚úÖ 1) Estados especiales que vienen del RPC (los respetamos)
  if (key.includes("PEND")) {
    return {
      documento: r.documento || "",
      nombre: r.nombre || "",
      cargo: r.cargo || "",
      area: r.area || "",
      certificacion: r.observacion || "",
      vigencia_desde: iso(r.fecha_inicio),
      vigencia_hasta: iso(r.fecha_vencimiento),
      dias: "‚Äî",
      estado_key: "PENDIENTE",
      estado_label: "Pendiente",
      estado_cls: "b-info"
    };
  }

  if (key.includes("NO_ENCONTR")) {
    return {
      documento: r.documento || "",
      nombre: r.nombre || "",
      cargo: r.cargo || "",
      area: r.area || "",
      certificacion: r.observacion || "",
      vigencia_desde: iso(r.fecha_inicio),
      vigencia_hasta: iso(r.fecha_vencimiento),
      dias: "‚Äî",
      estado_key: "NO_ENCONTRADO",
      estado_label: "No encontrado",
      estado_cls: "b-info"
    };
  }

  // ‚úÖ 2) Si no hay fecha de vencimiento => SIN_FECHA (Pendiente)
  const venceISO = iso(r.fecha_vencimiento);
  if (!venceISO) {
    return {
      documento: r.documento || "",
      nombre: r.nombre || "",
      cargo: r.cargo || "",
      area: r.area || "",
      certificacion: r.observacion || "",
      vigencia_desde: iso(r.fecha_inicio),
      vigencia_hasta: "",
      dias: "‚Äî",
      estado_key: "SIN_FECHA",
      estado_label: "Sin fecha",
      estado_cls: "b-info"
    };
  }

  // ‚úÖ 3) Calcular d√≠as con la fecha REAL (aqu√≠ nace el POR_VENCER)
  const daysLeft = daysBetweenToday(venceISO);

  const estado_key =
    (daysLeft < 0) ? "VENCIDO" :
    (daysLeft <= 30) ? "POR_VENCER" :
    "VIGENTE";

  const estado_label =
    (estado_key === "VIGENTE") ? "Vigente" :
    (estado_key === "POR_VENCER") ? "Por vencer" :
    "Vencido";

  const estado_cls =
    (estado_key === "VIGENTE") ? "b-ok" :
    (estado_key === "POR_VENCER") ? "b-warn" :
    "b-bad";

  return {
    documento: r.documento || "",
    nombre: r.nombre || "",
    cargo: r.cargo || "",
    area: r.area || "",
    certificacion: r.observacion || "",
    vigencia_desde: iso(r.fecha_inicio),
    vigencia_hasta: venceISO,
    dias: String(daysLeft),
    estado_key,
    estado_label,
    estado_cls
  };
});

  
  // 4) Llenar combo de √°reas (din√°mico)
  llenarAreas();

  // 5) Aplicar filtros y render
  aplicarFiltros();
renderResumenAreas();
status.textContent = "Listo.";
}
function llenarAreas(){
  // conservar lo que el usuario ya ten√≠a seleccionado
  const prev = areaSel.value || "TODAS";

  // obtener √°reas √∫nicas desde RAW
  const set = new Set();
  for(const r of RAW){
    const a = (r.area || "").trim();
    if(a) set.add(a);
  }

  const areas = Array.from(set).sort((a,b)=>a.localeCompare(b,"es"));

  // pintar options
  areaSel.innerHTML = `<option value="TODAS">Todas</option>` +
    areas.map(a => `<option value="${esc(a)}">${esc(a)}</option>`).join("");

  // restaurar selecci√≥n si existe
  if(areas.includes(prev)) areaSel.value = prev;
  else areaSel.value = "TODAS";
}
  function pct(n, d){
  if(!d || d<=0) return "0%";
  return ((n*100)/d).toFixed(1) + "%";
}

function renderResumenAreas(){
  if(!areaTbody) return;

  const totalGlobal = RAW.length || 0;

  // agrupamos por √°rea
  const map = new Map(); // area -> {tot, vig, porv, venc, pend}
  for(const r of RAW){
    const a = (r.area || "SIN √ÅREA").trim() || "SIN √ÅREA";
    if(!map.has(a)){
      map.set(a, { tot:0, vig:0, porv:0, venc:0, pend:0 });
    }
    const x = map.get(a);
    x.tot++;

    if(r.estado_key === "VIGENTE") x.vig++;
    else if(r.estado_key === "POR_VENCER") x.porv++;
    else if(r.estado_key === "VENCIDO") x.venc++;
   else if(
  r.estado_key === "SIN_FECHA" ||
  r.estado_key === "PENDIENTE" ||
  r.estado_key === "NO_ENCONTRADO"
) x.pend++;
  }

  // ordena por total desc
  const areas = Array.from(map.entries()).sort((aa,bb)=> (bb[1].tot - aa[1].tot));

  // Totales globales
  const totalVig  = RAW.filter(r=>r.estado_key==="VIGENTE").length;
  const totalPorv = RAW.filter(r=>r.estado_key==="POR_VENCER").length;
  const totalVenc = RAW.filter(r=>r.estado_key==="VENCIDO").length;
  const totalPend = RAW.filter(r =>
  r.estado_key==="SIN_FECHA" ||
  r.estado_key==="PENDIENTE" ||
  r.estado_key==="NO_ENCONTRADO"
).length;

  let html = `
    <tr style="background:rgba(167,139,250,.10);font-weight:900">
      <td>TOTAL</td>
      <td>${totalGlobal}</td>
      <td>${totalVig} (${pct(totalVig,totalGlobal)})</td>
      <td>${totalPorv} (${pct(totalPorv,totalGlobal)})</td>
      <td>${totalVenc} (${pct(totalVenc,totalGlobal)})</td>
      <td>${totalPend} (${pct(totalPend,totalGlobal)})</td>
      <td>100%</td>
    </tr>
  `;

  // Filas por √°rea
  for(const [area, x] of areas){
    html += `
      <tr>
        <td>${esc(area)}</td>
        <td><b>${x.tot}</b></td>
        <td>${x.vig} (${pct(x.vig,x.tot)})</td>
        <td>${x.porv} (${pct(x.porv,x.tot)})</td>
        <td>${x.venc} (${pct(x.venc,x.tot)})</td>
        <td>${x.pend} (${pct(x.pend,x.tot)})</td>
        <td>${pct(x.tot,totalGlobal)}</td>
      </tr>
    `;
  }

  areaTbody.innerHTML = html;
}
/* ================= FILTER + RENDER ================= */
function aplicarFiltros(){
  const est = estadoSel.value;
  const prox = Number(proxSel.value || "0");
  const qq = q.value.trim().toLowerCase();
const area = areaSel.value;
  let rows = RAW.slice();

  if(est !== "TODOS"){
    rows = rows.filter(r => r.estado_key === est);
  }
if(area !== "TODAS"){
  rows = rows.filter(r => (r.area || "").trim() === area);
}
  if(prox > 0){
    rows = rows.filter(r => {
      const d = (r.dias === "‚Äî") ? null : Number(r.dias);
      return (d !== null && d >= 0 && d <= prox);
    });
  }

  if(qq){
    rows = rows.filter(r => {
      const blob = (r.documento+" "+r.nombre+" "+r.cargo+" "+r.area+" "+r.certificacion).toLowerCase();
      return blob.includes(qq);
    });
  }

  // KPIs sobre TODO RAW (sin filtros de b√∫squeda), como operaci√≥n suele requerir global:
  const tot = RAW.length;
  const vig = RAW.filter(r=>r.estado_key==="VIGENTE").length;
  const porv = RAW.filter(r=>r.estado_key==="POR_VENCER").length;
  const venc = RAW.filter(r=>r.estado_key==="VENCIDO").length;

  kTot.textContent = tot;
  kVig.textContent = vig;
  kPorV.textContent = porv;
  kVenc.textContent = venc;

  // render
  tbody.innerHTML = rows.length ? "" : `
    <tr><td colspan="9" style="text-align:center;color:var(--muted);padding:18px">
      Sin resultados con los filtros actuales.
    </td></tr>
  `;

  for(const r of rows){
    tbody.innerHTML += `
      <tr>
        <td>${esc(r.documento)}</td>
        <td>${esc(r.nombre)}</td>
        <td>${esc(r.cargo)}</td>
        <td>${esc(r.area)}</td>
        <td>${esc(r.certificacion)}</td>
        <td><small>${esc(r.vigencia_desde || "‚Äî")}</small></td>
        <td><small>${esc(r.vigencia_hasta || "‚Äî")}</small></td>
        <td><b>${esc(r.dias)}</b></td>
        <td><span class="badge ${r.estado_cls}">${esc(r.estado_label)}</span></td>
      </tr>
    `;
  }

  status.textContent = `Mostrando: ${rows.length} / ${RAW.length}`;
}

estadoSel.onchange = aplicarFiltros;
  areaSel.onchange = aplicarFiltros;
proxSel.onchange = aplicarFiltros;
q.oninput = () => { aplicarFiltros(); };

refBtn.onclick = cargarTodo;

/* ================= CSV EXPORT ================= */
csvBtn.onclick = () => {
  // exporta LO QUE EST√Å FILTRADO en pantalla
  const est = estadoSel.value;
  const prox = Number(proxSel.value || "0");
  const qq = q.value.trim().toLowerCase();
  const area = areaSel.value;

  let rows = RAW.slice();
  if(est !== "TODOS") rows = rows.filter(r => r.estado_key === est);
  if(area !== "TODAS") rows = rows.filter(r => (r.area || "").trim() === area);
  if(prox > 0){
    rows = rows.filter(r => {
      const d = (r.dias === "‚Äî") ? null : Number(r.dias);
      return (d !== null && d >= 0 && d <= prox);
    });
  }
  if(qq){
  rows = rows.filter(r =>
    (r.documento+" "+r.nombre+" "+r.cargo+" "+r.area+" "+r.certificacion)
      .toLowerCase()
      .includes(qq)
  );
}

// ‚úÖ ALERT GENERAL (sirve con o sin b√∫squeda)
if(rows.length === 0){
  alert("No hay registros con esos filtros para exportar.");
  return;
}

  const header = ["documento","nombre","cargo","area","certificacion","vigencia_desde","vigencia_hasta","dias","estado"];
  const lines = [header.join(",")];

 for(const r of rows){
  const line = [
    r.documento, r.nombre, r.cargo, r.area, r.certificacion,
    r.vigencia_desde, r.vigencia_hasta, r.dias, r.estado_label
  ].map(x => `"${String(x ?? "").replaceAll('"','""')}"`).join(",");

  lines.push(line);
}
    const blob = new Blob([lines.join("\n")], { type:"text/csv;charset=utf-8" });
  const url = URL.createObjectURL(blob);

  const a = document.createElement("a");
  a.href = url;
  a.download = "recertificaciones_claro.csv";  
  document.body.appendChild(a);
  a.click();
  a.remove();

  URL.revokeObjectURL(url);
};
</script>

</body>
</html>
