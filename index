<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Formaci√≥n DICO ‚Äì Operaci√≥n | Recertificaciones</title>

<script src="https://unpkg.com/@supabase/supabase-js@2"></script>

<style>
:root{
  --violeta:#a78bfa;--violeta-osc:#7c3aed;
  --bg:#0b0c1a;--bg2:#161737;
  --card:#17182b;--text:#e8e6ff;--muted:#bfbde6;
  --border:rgba(167,139,250,.25);
  --danger:#f87171;--success:#34d399;--warn:#facc15;--info:#60a5fa;
}
*{box-sizing:border-box;font-family:Inter,system-ui,Segoe UI,Roboto,sans-serif;}
body{
  margin:0;min-height:100vh;
  background:linear-gradient(130deg,var(--bg),var(--bg2));
  color:var(--text);
  display:flex;justify-content:center;padding:16px;
}
.hidden{display:none!important}
.card{
  width:100%;max-width:1200px;background:rgba(23,24,43,.95);
  border:1px solid var(--border);border-radius:20px;
  box-shadow:0 18px 45px rgba(0,0,0,.7);
  padding:22px 20px 18px;
}
h1{margin:0 0 6px;text-align:center;font-size:20px;font-weight:800}
.sub{margin:0 0 14px;text-align:center;color:var(--muted);font-size:13px}
input,select{
  padding:9px 11px;border-radius:12px;background:#0e0f25;color:var(--text);
  border:1px solid rgba(167,139,250,.35);
}
button{
  border:0;border-radius:999px;padding:9px 14px;font-size:13px;font-weight:700;cursor:pointer;
  background:linear-gradient(135deg,var(--violeta-osc),var(--violeta));color:white;
}
button.sec{background:#211334;border:1px solid rgba(167,139,250,.4)}
button:disabled{opacity:.6;cursor:not-allowed}
.grid{display:grid;gap:10px}
.grid-4{grid-template-columns:repeat(4,minmax(0,1fr))}
@media (max-width:980px){.grid-4{grid-template-columns:repeat(2,minmax(0,1fr))}}
.kpi{
  background:rgba(167,139,250,.10);
  border:1px solid rgba(167,139,250,.35);
  border-radius:14px;padding:10px 12px;
}
.kpi .t{color:var(--muted);font-size:12px}
.kpi .v{font-size:18px;font-weight:900;margin-top:4px}
.row{display:flex;gap:10px;flex-wrap:wrap;align-items:end}
.badge{padding:4px 8px;border-radius:999px;font-size:11px;font-weight:800;border:1px solid rgba(255,255,255,.15)}
.b-ok{background:rgba(52,211,153,.12);color:var(--success)}
.b-w{background:rgba(250,204,21,.14);color:var(--warn)}
.b-bad{background:rgba(248,113,113,.14);color:var(--danger)}
.b-i{background:rgba(96,165,250,.14);color:var(--info)}
.table-wrap{
  margin-top:10px;border-radius:12px;overflow:auto;max-height:520px;
  border:1px solid rgba(167,139,250,.22);background:#050617;
}
table{width:100%;border-collapse:collapse;font-size:12px}
thead{position:sticky;top:0;background:#101226}
th,td{padding:10px 10px;border-bottom:1px solid rgba(167,139,250,.12);text-align:left;white-space:nowrap}
tbody tr:nth-child(even){background:#101226}
tbody tr:hover{background:#181a3a}
.small{font-size:12px;color:var(--muted)}
hr{border:0;border-top:1px solid rgba(167,139,250,.18);margin:12px 0}
.modal-backdrop{
  position:fixed;inset:0;background:rgba(0,0,0,.65);
  display:flex;align-items:center;justify-content:center;z-index:999;
}
.modal{
  width:92%;max-width:980px;background:#111329;border:1px solid var(--border);
  border-radius:14px;padding:16px;
}
</style>
</head>

<body>

<!-- LOGIN -->
<div class="card" id="loginCard">
  <h1>Formaci√≥n DICO ‚Äì Operaci√≥n</h1>
  <div class="sub">Panel de recertificaciones (CLARO)</div>

  <label>Correo</label>
  <input id="email" type="email" style="width:100%;margin-top:4px;">
  <label style="margin-top:10px;display:block;">Contrase√±a</label>
  <input id="pass" type="password" style="width:100%;margin-top:4px;">
  <button id="loginBtn" style="width:100%;margin-top:12px;">Ingresar</button>
  <div id="loginStatus" class="small" style="text-align:center;margin-top:10px;"></div>
</div>

<!-- DASH -->
<div class="card hidden" id="dashCard">
  <h1>Recertificaciones ‚Äì Operaci√≥n (CLARO)</h1>
  <div class="sub">Vigentes / Por vencer / Vencidas + Hist√≥rico de intentos</div>

  <div style="display:flex;justify-content:space-between;gap:10px;align-items:center;flex-wrap:wrap;margin-bottom:10px;">
    <div class="small" id="userBadge"></div>
    <div style="display:flex;gap:8px;flex-wrap:wrap;">
      <button class="sec" id="refreshBtn">üîÑ Actualizar</button>
      <button class="sec" id="exportBtn">‚¨á Exportar CSV</button>
      <button class="sec" id="logoutBtn">Salir</button>
    </div>
  </div>

  <!-- KPIs -->
  <div class="grid grid-4" style="margin-top:6px;">
    <div class="kpi"><div class="t">Total registros</div><div class="v" id="kTotal">--</div></div>
    <div class="kpi"><div class="t">Vigentes</div><div class="v" id="kVig">--</div></div>
    <div class="kpi"><div class="t">Por vencer (‚â§30 d√≠as)</div><div class="v" id="k30">--</div></div>
    <div class="kpi"><div class="t">Vencidas</div><div class="v" id="kVen">--</div></div>
  </div>

  <hr/>

  <!-- FILTROS -->
  <div class="row">
    <div>
      <label class="small">Buscar (c√©dula / nombre)</label><br>
      <input id="q" placeholder="Ej: 1022... o Juan" style="min-width:260px;">
    </div>

    <div>
      <label class="small">√Årea</label><br>
      <select id="fArea" style="min-width:180px;">
        <option value="">(Todas)</option>
      </select>
    </div>

    <div>
      <label class="small">Cargo</label><br>
      <select id="fCargo" style="min-width:240px;">
        <option value="">(Todos)</option>
      </select>
    </div>

    <div>
      <label class="small">Estado</label><br>
      <select id="fEstado" style="min-width:190px;">
        <option value="">(Todos)</option>
        <option value="VIGENTE">VIGENTE</option>
        <option value="POR_VENCER">POR VENCER</option>
        <option value="VENCIDA">VENCIDA</option>
      </select>
    </div>

    <div>
      <label class="small">Corte hasta</label><br>
      <input id="fHasta" type="date">
    </div>

    <button id="applyBtn">Aplicar</button>
    <button class="sec" id="clearBtn">Limpiar</button>
  </div>

  <div class="small" id="status" style="margin-top:10px;"></div>

  <!-- TABLA -->
  <div class="table-wrap">
    <table>
      <thead>
        <tr>
          <th>Documento</th>
          <th>Nombre</th>
          <th>√Årea</th>
          <th>Cargo</th>
          <th>Certificaci√≥n</th>
          <th>Vigencia desde</th>
          <th>Vigencia hasta</th>
          <th>D√≠as</th>
          <th>Estado</th>
          <th>√ölt. actualizaci√≥n</th>
          <th>Hist√≥rico</th>
        </tr>
      </thead>
      <tbody id="tbody"></tbody>
    </table>
  </div>
</div>

<!-- MODAL HIST√ìRICO -->
<div class="modal-backdrop hidden" id="histModal">
  <div class="modal">
    <div style="display:flex;justify-content:space-between;gap:10px;align-items:center;flex-wrap:wrap;">
      <div>
        <div style="font-weight:900" id="histTitle">Hist√≥rico</div>
        <div class="small" id="histSub"></div>
      </div>
      <button class="sec" id="closeHistBtn">Cerrar</button>
    </div>

    <div class="table-wrap" style="max-height:420px;margin-top:10px;">
      <table>
        <thead>
          <tr>
            <th>Fecha</th>
            <th>Formador</th>
            <th>Te√≥rica</th>
            <th>Pr√°ctica</th>
            <th>Calibraci√≥n</th>
            <th>Promedio</th>
            <th>Vigencia hasta</th>
          </tr>
        </thead>
        <tbody id="tbodyHist"></tbody>
      </table>
    </div>
    <div class="small" id="histStatus" style="margin-top:10px;"></div>
  </div>
</div>

<script>
/* ================== CONFIG SUPABASE ================== */
const SUPABASE_URL = "https://zltjlwfnqrjojguewaiq.supabase.co";
const SUPABASE_KEY = "sb_publishable_Q_-wmXnWL1V5A8gjSgjZTQ_UumLas2f";
const sb = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

/* ================== HELPERS ================== */
function isoOnly(x){ return (x||"").toString().slice(0,10); }
function daysBetween(fromISO, toISO){
  if(!toISO) return null;
  const a = new Date((fromISO||new Date().toISOString().slice(0,10))+"T00:00:00");
  const b = new Date(toISO+"T00:00:00");
  const ms = b - a;
  return Math.floor(ms / (1000*60*60*24));
}
function estadoByDias(dias){
  if(dias === null || dias === undefined) return { key:"", label:"SIN FECHA", cls:"b-i" };
  if(dias < 0) return { key:"VENCIDA", label:"VENCIDA", cls:"b-bad" };
  if(dias <= 30) return { key:"POR_VENCER", label:`POR VENCER (${dias}d)`, cls:"b-w" };
  return { key:"VIGENTE", label:`VIGENTE (${dias}d)`, cls:"b-ok" };
}
function csvEscape(s){
  const t = (s ?? "").toString();
  if(/[",\n]/.test(t)) return `"${t.replaceAll('"','""')}"`;
  return t;
}

/* ================== DOM ================== */
const loginCard = document.getElementById("loginCard");
const dashCard  = document.getElementById("dashCard");

const loginStatus = document.getElementById("loginStatus");
const userBadge   = document.getElementById("userBadge");
const loginBtn    = document.getElementById("loginBtn");
const logoutBtn   = document.getElementById("logoutBtn");

const refreshBtn = document.getElementById("refreshBtn");
const exportBtn  = document.getElementById("exportBtn");

const kTotal = document.getElementById("kTotal");
const kVig   = document.getElementById("kVig");
const k30    = document.getElementById("k30");
const kVen   = document.getElementById("kVen");

const q      = document.getElementById("q");
const fArea  = document.getElementById("fArea");
const fCargo = document.getElementById("fCargo");
const fEstado= document.getElementById("fEstado");
const fHasta = document.getElementById("fHasta");
const applyBtn = document.getElementById("applyBtn");
const clearBtn = document.getElementById("clearBtn");

const status = document.getElementById("status");
const tbody  = document.getElementById("tbody");

/* Modal hist√≥rico */
const histModal = document.getElementById("histModal");
const closeHistBtn = document.getElementById("closeHistBtn");
const histTitle = document.getElementById("histTitle");
const histSub = document.getElementById("histSub");
const tbodyHist = document.getElementById("tbodyHist");
const histStatus = document.getElementById("histStatus");

/* ================== DATA CACHE ================== */
let RAW = [];        // registros crudos (employee_certifications join employees)
let VIEW = [];       // registros con estado calculado
let LAST_EXPORT = []; // √∫ltima tabla filtrada para exportar

/* ================== AUTH ================== */
loginBtn.onclick = async () => {
  const email = document.getElementById("email").value.trim();
  const pass  = document.getElementById("pass").value.trim();
  if(!email || !pass){ loginStatus.textContent="‚ùå Digita correo y contrase√±a."; return; }

  loginStatus.textContent = "Ingresando...";
  const { data, error } = await sb.auth.signInWithPassword({ email, password: pass });
  if(error){ loginStatus.textContent = "‚ùå " + error.message; return; }
  loginStatus.textContent = "‚úÖ Bienvenido";
  userBadge.textContent = data.user.email;
};

sb.auth.onAuthStateChange((event, session) => {
  if(!session || !session.user){
    loginCard.classList.remove("hidden");
    dashCard.classList.add("hidden");
    return;
  }
  loginCard.classList.add("hidden");
  dashCard.classList.remove("hidden");
  userBadge.textContent = session.user.email;
  cargar();
});

logoutBtn.onclick = async () => { await sb.auth.signOut(); };

/* ================== CARGA PRINCIPAL ================== */
async function cargar(){
  status.textContent = "Cargando datos...";
  tbody.innerHTML = "";
  RAW = [];
  VIEW = [];
  LAST_EXPORT = [];

  // Trae TODAS las certificaciones + datos empleados
  // (Si despu√©s quieres filtrar por cliente, lo hacemos con employee_client_certifications / vista)
  const { data, error } = await sb
    .from("employee_certifications")
    .select(`
      id, employee_id, certificacion,
      fecha_teorica, fecha_practica, fecha_calibracion,
      nota_teorica, nota_practica, nota_calibracion, nota_promedio,
      vigencia_desde, vigencia_hasta,
      formador_email, updated_at,
      employees ( documento, nombre, cargo, area )
    `)
    .order("vigencia_hasta", { ascending: true, nullsFirst: false });

  if(error){
    status.textContent = "‚ùå Error cargando.";
    alert(error.message);
    return;
  }

  RAW = data || [];

  // construir VIEW (estado calculado por vigencia_hasta)
  const hoy = new Date().toISOString().slice(0,10);
  VIEW = RAW.map(r => {
    const emp = r.employees || {};
    const dias = daysBetween(hoy, r.vigencia_hasta);
    const est  = estadoByDias(dias);
    return {
      employee_id: r.employee_id,
      documento: emp.documento || "",
      nombre: emp.nombre || "",
      area: emp.area || "",
      cargo: emp.cargo || "",
      certificacion: r.certificacion || "",
      vigencia_desde: r.vigencia_desde ? isoOnly(r.vigencia_desde) : "",
      vigencia_hasta: r.vigencia_hasta ? isoOnly(r.vigencia_hasta) : "",
      dias: (dias===null? "" : dias),
      estado_key: est.key,
      estado_label: est.label,
      estado_cls: est.cls,
      updated_at: r.updated_at ? isoOnly(r.updated_at) : "",
      formador_email: r.formador_email || "",
      _raw: r
    };
  });

  // llenar combos √°rea/cargo
  llenarCombos();
  // KPIs
  pintarKPIs(VIEW);
  // pintar tabla con filtros actuales
  aplicarFiltros();

  status.textContent = `‚úÖ Registros cargados: ${VIEW.length}`;
}

function llenarCombos(){
  const areas = [...new Set(VIEW.map(x=>x.area).filter(Boolean))].sort();
  const cargos = [...new Set(VIEW.map(x=>x.cargo).filter(Boolean))].sort();

  fArea.innerHTML = `<option value="">(Todas)</option>` + areas.map(a=>`<option value="${a}">${a}</option>`).join("");
  fCargo.innerHTML = `<option value="">(Todos)</option>` + cargos.map(c=>`<option value="${c}">${c}</option>`).join("");
}

function pintarKPIs(list){
  const total = list.length;
  const vig = list.filter(x=>x.estado_key==="VIGENTE").length;
  const porv = list.filter(x=>x.estado_key==="POR_VENCER").length;
  const ven = list.filter(x=>x.estado_key==="VENCIDA").length;

  kTotal.textContent = total;
  kVig.textContent = vig;
  k30.textContent = porv;
  kVen.textContent = ven;
}

/* ================== FILTROS Y TABLA ================== */
function aplicarFiltros(){
  const qq = q.value.trim().toLowerCase();
  const a  = fArea.value;
  const c  = fCargo.value;
  const e  = fEstado.value;
  const hasta = fHasta.value ? new Date(fHasta.value+"T23:59:59") : null;

  const filtrados = VIEW.filter(x=>{
    if(qq){
      const hay = (x.documento+" "+x.nombre).toLowerCase();
      if(!hay.includes(qq)) return false;
    }
    if(a && x.area !== a) return false;
    if(c && x.cargo !== c) return false;
    if(e && x.estado_key !== e) return false;

    if(hasta && x.vigencia_hasta){
      const vh = new Date(x.vigencia_hasta+"T00:00:00");
      if(vh > hasta) return false;
    }
    return true;
  });

  LAST_EXPORT = filtrados;
  pintarKPIs(filtrados);
  pintarTabla(filtrados);

  status.textContent = `Mostrando: ${filtrados.length} de ${VIEW.length}`;
}

function pintarTabla(list){
  tbody.innerHTML = "";
  if(!list.length){
    tbody.innerHTML = `<tr><td colspan="11" style="text-align:center;color:var(--muted);padding:14px;">Sin resultados.</td></tr>`;
    return;
  }

  for(const x of list){
    tbody.innerHTML += `
      <tr>
        <td>${x.documento}</td>
        <td>${x.nombre}</td>
        <td>${x.area}</td>
        <td>${x.cargo}</td>
        <td>${x.certificacion}</td>
        <td>${x.vigencia_desde}</td>
        <td>${x.vigencia_hasta}</td>
        <td>${x.dias}</td>
        <td><span class="badge ${x.estado_cls}">${x.estado_label}</span></td>
        <td title="${x.formador_email}">${x.updated_at}</td>
        <td>
          <button class="sec btnHist" data-eid="${x.employee_id}" data-cert="${encodeURIComponent(x.certificacion)}" style="padding:6px 10px;font-size:12px;">üìö Ver</button>
        </td>
      </tr>
    `;
  }

  document.querySelectorAll(".btnHist").forEach(b=>{
    b.onclick = () => openHist(b.dataset.eid, decodeURIComponent(b.dataset.cert));
  });
}

applyBtn.onclick = aplicarFiltros;
clearBtn.onclick = () => {
  q.value=""; fArea.value=""; fCargo.value=""; fEstado.value=""; fHasta.value="";
  aplicarFiltros();
};
refreshBtn.onclick = cargar;

/* ================== HIST√ìRICO ================== */
closeHistBtn.onclick = () => histModal.classList.add("hidden");

async function openHist(employeeId, certificacion){
  histModal.classList.remove("hidden");
  tbodyHist.innerHTML = "";
  histStatus.textContent = "Cargando hist√≥rico...";

  histTitle.textContent = "Hist√≥rico de certificaci√≥n";
  histSub.textContent = `employee_id: ${employeeId} | ${certificacion}`;

  // Traer hist√≥rico (m√°s reciente primero)
  const { data, error } = await sb
    .from("employee_certifications_history")
    .select(`
      employee_id, certificacion,
      nota_teorica, nota_practica, nota_calibracion, nota_promedio,
      vigencia_hasta, formador_email, updated_at, created_at
    `)
    .eq("employee_id", employeeId)
    .eq("certificacion", certificacion)
    .order("created_at", { ascending: false });

  if(error){
    histStatus.textContent = "‚ùå Error cargando hist√≥rico.";
    alert(error.message);
    return;
  }

  const rows = data || [];
  if(!rows.length){
    tbodyHist.innerHTML = `<tr><td colspan="7" style="text-align:center;color:var(--muted);padding:14px;">Sin hist√≥rico para este registro.</td></tr>`;
    histStatus.textContent = "0 filas";
    return;
  }

  rows.forEach(r=>{
    const fecha = isoOnly(r.created_at || r.updated_at);
    tbodyHist.innerHTML += `
      <tr>
        <td>${fecha}</td>
        <td>${r.formador_email || ""}</td>
        <td>${r.nota_teorica ?? ""}</td>
        <td>${r.nota_practica ?? ""}</td>
        <td>${r.nota_calibracion ?? ""}</td>
        <td>${r.nota_promedio ?? ""}</td>
        <td>${isoOnly(r.vigencia_hasta)}</td>
      </tr>
    `;
  });

  histStatus.textContent = `Filas: ${rows.length}`;
}

/* ================== EXPORT CSV ================== */
exportBtn.onclick = () => {
  const rows = LAST_EXPORT || [];
  if(!rows.length) return alert("No hay datos para exportar.");

  const header = [
    "documento","nombre","area","cargo","certificacion",
    "vigencia_desde","vigencia_hasta","dias","estado","updated_at"
  ];

  const lines = [header.join(",")];
  for(const x of rows){
    lines.push([
      csvEscape(x.documento),
      csvEscape(x.nombre),
      csvEscape(x.area),
      csvEscape(x.cargo),
      csvEscape(x.certificacion),
      csvEscape(x.vigencia_desde),
      csvEscape(x.vigencia_hasta),
      csvEscape(x.dias),
      csvEscape(x.estado_key),
      csvEscape(x.updated_at),
    ].join(","));
  }

  const blob = new Blob([lines.join("\n")], {type:"text/csv;charset=utf-8;"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "recertificaciones_operacion.csv";
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);
};

/* auto-recalcular al teclear */
["input","change"].forEach(ev=>{
  q.addEventListener(ev, aplicarFiltros);
  fArea.addEventListener(ev, aplicarFiltros);
  fCargo.addEventListener(ev, aplicarFiltros);
  fEstado.addEventListener(ev, aplicarFiltros);
  fHasta.addEventListener(ev, aplicarFiltros);
});
</script>
</body>
</html>
